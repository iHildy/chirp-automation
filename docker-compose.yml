services:
  chirp-automation:
    container_name: chirp-automation
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/Dockerfile
    ports:
      - "${CHIRP_HTTP_PORT:-3000}:${PORT:-8080}"
      - "${CHIRP_VNC_PORT:-6080}:6080"
    environment:
      API_TOKEN: "${API_TOKEN}"
      PORT: "${PORT:-8080}"
      ADB_SERIAL: "${ADB_SERIAL:-emulator-5554}"
      ADB_CONNECT: "${ADB_CONNECT:-}"
      ACTIONS_PATH: "/opt/chirp/config/actions.yaml"
      ARTIFACTS_DIR: "/opt/chirp/data/artifacts"
      EMULATOR_DEVICE: "${EMULATOR_DEVICE:-Nexus 5}"
      WEB_VNC: "true"
      SKIP_EMULATOR_START: "${SKIP_EMULATOR_START:-false}"
    volumes:
      - ./config:/opt/chirp/config
      - ./data:/opt/chirp/data
      # budtmo/docker-android persists emulator + ADB state under /home/androidusr
      - android-home:/home/androidusr
    devices:
      - /dev/kvm
    privileged: true
    develop:
      watch:
        - action: rebuild
          path: ./src
        - action: rebuild
          path: ./package.json
        - action: rebuild
          path: ./tsconfig.json

volumes:
  android-home:
